{% extends "base.html" %}
{% block title %}√âvolution du Solde Calendrier{% endblock %}
{% block content %}

<h1 class="h3 mb-4 text-gray-800 text-center">√âvolution du Solde Calendrier</h1>

<form method="get" class="d-flex flex-wrap justify-content-center align-items-end gap-3 mb-4">
    <div>
        <label for="start_date">De :</label>
        <input type="date" name="start_date" id="start_date" class="form-control"
               value="{{ request.args.get('start_date', '') }}">
    </div>
    <div>
        <label for="end_date">√Ä :</label>
        <input type="date" name="end_date" id="end_date" class="form-control"
               value="{{ request.args.get('end_date', '') }}">
    </div>
    <div>
        <label for="time_scale">√âchelle :</label>
        <select name="time_scale" id="time_scale" class="form-select form-select-sm w-auto">
            <option value="day" {% if time_scale == 'day' %}selected{% endif %}>Jour</option>
            <option value="month" {% if time_scale == 'month' or not time_scale %}selected{% endif %}>Mois</option>
            <option value="year" {% if time_scale == 'year' %}selected{% endif %}>Ann√©e</option>
        </select>
    </div>
    <div class="form-check mt-4">
        <input class="form-check-input" type="checkbox" name="cumul" id="cumul" value="true"
               {% if cumul %}checked{% endif %}>
        <label class="form-check-label" for="cumul">Afficher en cumul</label>
    </div>
    <div>
        <button type="submit" class="btn btn-primary">Filtrer</button>
        <a href="{{ url_for('graph_solde') }}" class="btn btn-secondary">R√©initialiser</a>
    </div>
</form>


<!-- Encadr√© solde_info -->
{% if solde_info %}
<div style="
    position: fixed;
    top: 4.5rem;
    right: 1rem;
    background: white;
    border: 1px solid #ddd;
    padding: 0.8rem 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    min-width: 240px;
    z-index: 1000;
">
    <p>üí∞ <b>Solde actuel :</b> {{ "%.2f"|format(solde_info.solde_actuel) }} ‚Ç¨</p>
    <p>üìâ <b>Reste autoris√© (avec d√©couvert) :</b> {{ solde_info.disponible_avec_decouvert }} ‚Ç¨</p>
    <p>üìÖ <b>Jours restants avant paie :</b> {{ solde_info.jours_restant }}</p>
    <p>üóìÔ∏è <b>Prochaine paie :</b> {{ solde_info.prochaine_paie }}</p>
</div>
{% endif %}

<!-- Graphique -->
{% if labels and values %}
<canvas id="graphSolde" height="100"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
    const ctx = document.getElementById('graphSolde').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ labels|tojson }},
            datasets: [{
                label: 'Solde (‚Ç¨)',
                data: {{ values|tojson }},
                fill: true,
                borderColor: 'green',
                backgroundColor: 'rgba(0,128,0,0.1)',
                tension: 0.3,
                pointRadius: 3,
                pointBackgroundColor: 'orange'
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: "{{ time_scale if time_scale else 'month' }}"
                    }
                },
                y: {
                    beginAtZero: false
                }
            }
        }
    });
</script>
{% else %}
<div class="alert alert-warning text-center mt-4">Aucune donn√©e disponible pour ce graphique.</div>
{% endif %}

{% endblock %}
